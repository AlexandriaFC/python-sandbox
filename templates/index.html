<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Address Autocomplete</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <!-- 1) Define the initMap callback BEFORE loading the API -->
  <script>
    async function initMap() {
      // Load the new Places library
      const { PlaceAutocompleteElement } = await google.maps.importLibrary("places");
      
      // Create the autocomplete widget
      const placeAutocomplete = new PlaceAutocompleteElement();
      
      // (Optional) set a placeholder
      placeAutocomplete.placeholder = "Start typing your addressâ€¦";
      // Restrict to US
      placeAutocomplete.componentRestrictions = { country: "US" };
      
      // Insert it into our form container
      document.getElementById("autocomplete-container")
              .appendChild(placeAutocomplete);

      // When the user picks a place, fetch and store the formatted address
      placeAutocomplete.addEventListener("gmp-select", async ({ placePrediction }) => {
        const place = placePrediction.toPlace();
        await place.fetchFields({ fields: ["formattedAddress"] });
        document.getElementById("address-value").value = place.formattedAddress;
      });
    }
  </script>

  <!-- 2) Load the Maps JS API (weekly build) with our callback -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCXaaG2c6zzMxbvWwVQ6ccWoJ2-TEvm_8A&v=weekly&callback=initMap"
    async
    defer
  ></script>
</head>
<body>
  <h1>Enter your address</h1>

  {% if success %}
    <p class="success">Successfully submitted!</p>
  {% endif %}

  <form action="/" method="post">
    <!-- Container where the PlaceAutocompleteElement will render itself -->
    <div id="autocomplete-container"></div>
    <!-- Hidden field that actually sends the chosen address to Flask -->
    <input type="hidden" name="address" id="address-value" />
    <button type="submit">Save</button>
  </form>
</body>
</html>
